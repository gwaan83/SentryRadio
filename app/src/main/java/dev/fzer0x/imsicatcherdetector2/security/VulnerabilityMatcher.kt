package dev.fzer0x.imsicatcherdetector2.security

import java.text.SimpleDateFormat
import java.util.Locale

object VulnerabilityMatcher {

    fun isChipsetAffected(description: String, deviceChipset: String): Boolean {
        val desc = description.lowercase()
        val chip = deviceChipset.lowercase()

        if (desc.contains(chip)) return true

        val commonNames = mapOf(

            // =========================
            // Qualcomm Snapdragon 8-Series
            // =========================
            "sm8750" to listOf("snapdragon 8 gen 4", "qualcomm", "storm"),
            "sm8650" to listOf("snapdragon 8 gen 3", "qualcomm", "pineapple"),
            "sm8550" to listOf("snapdragon 8 gen 2", "qualcomm", "kalama"),
            "sm8450" to listOf("snapdragon 8 gen 1", "qualcomm"),
            "sm8350" to listOf("snapdragon 888", "qualcomm", "lahaina"),
            "sm8250" to listOf("snapdragon 865", "qualcomm", "kona"),
            "sm8150" to listOf("snapdragon 855", "qualcomm", "msmnile"),
            "sdm845" to listOf("snapdragon 845", "qualcomm"),
            "sdm835" to listOf("snapdragon 835", "qualcomm", "msm8998"),

            // =========================
            // Google Tensor
            // =========================
            "gs101" to listOf("google tensor", "tensor g1", "whitechapel"),
            "gs201" to listOf("tensor g2", "google tensor g2", "cloudripper"),
            "gs301" to listOf("tensor g3", "google tensor g3", "zuma"),
            "gs401" to listOf("tensor g4", "google tensor g4", "zuma pro", "zumapro"),

            // =========================
            // MediaTek Dimensity
            // =========================
            "mt6990" to listOf("dimensity 9400", "mediatek"),
            "mt6989" to listOf("dimensity 9300", "mediatek"),
            "mt6985" to listOf("dimensity 9200", "mediatek"),
            "mt6983" to listOf("dimensity 9000", "mediatek"),
            "mt6895" to listOf("dimensity 8100", "mediatek"),
            "mt6893" to listOf("dimensity 1200", "mediatek"),
            "mt6879" to listOf("dimensity 1000", "mediatek"),
            "mt6877" to listOf("dimensity 900", "mediatek"),
            "mt6875" to listOf("dimensity 800", "mediatek"),
            "mt6853" to listOf("dimensity 700", "mediatek"),
            "mt6833" to listOf("dimensity 600", "mediatek"),

            // =========================
            // MediaTek Helio
            // =========================
            "mt6765" to listOf("helio p60", "mediatek"),
            "mt6779" to listOf("helio g90t", "mediatek"),
            "mt6785" to listOf("helio g80", "mediatek"),
            "mt6768" to listOf("helio g85", "mediatek"),

            // =========================
            // Legacy MediaTek
            // =========================
            "mt6735" to listOf("mt6735", "mediatek"),
            "mt6737" to listOf("mt6737", "mediatek"),
            "mt6739" to listOf("mt6739", "mediatek"),
            "mt6750" to listOf("mt6750", "mediatek"),
            "mt6752" to listOf("mt6752", "mediatek"),
            "mt6795" to listOf("mt6795", "mediatek"),

            // =========================
            // Samsung Exynos
            // =========================
            "exynos2500" to listOf("s5e9925", "samsung", "exynos"),
            "exynos2400" to listOf("s5e9945", "samsung", "exynos"),
            "exynos2100" to listOf("s5e9840", "samsung", "exynos"),
            "exynos1280" to listOf("s5e8835", "samsung", "exynos"),
            "exynos1080" to listOf("s5e8825", "samsung", "exynos"),
            "exynos990" to listOf("s5e9830", "samsung", "exynos"),
            "exynos980" to listOf("s5e8820", "samsung", "exynos"),
            "exynos9611" to listOf("s5e9823", "samsung", "exynos"),
            "exynos9825" to listOf("s5e9810", "samsung", "exynos"),
            "exynos9820" to listOf("s5e9800", "samsung", "exynos"),

            // =========================
            // Legacy Exynos
            // =========================
            "exynos7420" to listOf("exynos 7420", "samsung"),
            "exynos8890" to listOf("exynos 8890", "samsung"),
            "exynos8895" to listOf("exynos 8895", "samsung"),
            "exynos9810" to listOf("exynos 9810", "samsung"),

            // =========================
            // UNISOC (Spreadtrum)
            // =========================
            "ums512" to listOf("unisoc t770", "spreadtrum", "unisoc"),
            "ums9620" to listOf("unisoc t820", "spreadtrum", "unisoc"),
            "ums9230" to listOf("unisoc t606", "spreadtrum", "unisoc"),
            "sc9863a" to listOf("unisoc sc9863a", "spreadtrum", "unisoc"),
            "sc9832e" to listOf("unisoc sc9832e", "spreadtrum", "unisoc"),
            "sc7731e" to listOf("unisoc sc7731e", "spreadtrum", "unisoc"),

            // =========================
            // Generic fallbacks
            // =========================
            "qcom" to listOf("qualcomm", "snapdragon"),
            "msm" to listOf("qualcomm", "snapdragon"),
            "mt" to listOf("mediatek", "dimensity", "helio"),
            "exynos" to listOf("samsung", "exynos"),
            "unisoc" to listOf("spreadtrum", "unisoc")
        )

        commonNames[chip]?.forEach { alias ->
            if (desc.contains(alias)) return true
        }

        return false
    }

    fun isVulnerable(cve: CveEntry, securityPatch: String): Boolean {
        val patchDate = try {
            SimpleDateFormat("yyyy-MM", Locale.US).parse(securityPatch)?.time ?: 0L
        } catch (e: Exception) {
            0L
        }

        return cve.publishedDate > patchDate
    }
}
